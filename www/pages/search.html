<template>
	<div class="page" data-name="search">
		<!-- Navbar -->
		<div class="navbar">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				<div class="left">
					<a href="#" class="link back">
						<i class="icon icon-back"></i>
						<span class="if-not-md">Back</span>
					</a>
				</div>
				<div class="title">Search</div>
			</div>
		</div>
		<!-- Page content -->
		<div class="page-content">
			<!-- Left panel with cover effect -->
			<!-- Form -->
			<form class="list" id="search-product-form">
				<div class="list">
					<div class="list no-hairlines-md">
						<ul class="row">
							<li class="col-95 item-content item-input">
								<div class="item-inner">
									<div class="item-input-wrap">
										<input id="product-code" name="code" type="text" placeholder="Code" />
										<span class="input-clear-button"></span>
									</div>
								</div>
								<i class="icon f7-icons popup-open popup-code-list" data-popup=".popup-code-list">barcode_viewfinder</i>
							</li>
							<li class="col-100 item-content item-input">
								<div class="item-inner">
									<div class="item-input-wrap">
										<a class="button popup-open popup-product-list" href="#" data-popup=".popup-product-list"><input id="product-name" name="name" type="text" placeholder="Product Name" /></a>
										<span class="input-clear-button"></span>
									</div>
								</div>
							</li>
							<li class="col-95 item-content item-input">
								<div class="item-inner">
									<div class="item-input-wrap">
										<input id="product-shop" name="shop" type="text" placeholder="Shop Name" />
										<span class="input-clear-button"></span>
									</div>
								</div>
								<i class="icon f7-icons popup-open popup-shop-list" data-popup=".popup-shop-list">cart</i>
							</li>
						</ul>
					</div>
				</div>
				<!-- Pop up code list -->
				<div class="popup popup-code-list">
					<div class="navbar">
						<div class="navbar-bg"></div>
						<div class="navbar-inner sliding">
							<div class="left">
								<a href="#" class="link popup-close">
									<i class="icon icon-back"></i>
									<span class="if-not-md">Back</span>
								</a>
							</div>
							<div class="title">Barcodes</div>
						</div>
					</div>
					<div class="list">
						<ul id="popup-codes"></ul>
					</div>
				</div>
				<!-- Pop up product list -->
				<div class="popup popup-product-list">
					<div class="navbar">
						<div class="navbar-bg"></div>
						<div class="navbar-inner sliding">
							<div class="left">
								<a href="#" class="link popup-close">
									<i class="icon icon-back"></i>
									<span class="if-not-md">Back</span>
								</a>
							</div>
							<div class="title">Products</div>
						</div>
					</div>
					<div class="list">
						<ul id="popup-products"></ul>
					</div>
				</div>
				<!-- Pop up shop list -->
				<div class="popup popup-shop-list">
					<div class="navbar">
						<div class="navbar-bg"></div>
						<div class="navbar-inner sliding">
							<div class="left">
								<a href="#" class="link popup-close">
									<i class="icon icon-back"></i>
									<span class="if-not-md">Back</span>
								</a>
							</div>
							<div class="title">Shop List</div>
						</div>
					</div>
					<div class="list">
						<ul id="popup-shops"></ul>
					</div>
				</div>
				<!-- Button -->
				<div class="block">
					<div class="row">
						<div class="col-50">
							<a href="#" class="button button-raised button-fill convert-product-form-to-data">Search</a>
						</div>
						<div class="col-50">
							<a href="#" class="button button-raised button-fill" @click="$root.emptySearchForm()">Clear</a>
						</div>
					</div>
				</div>
				<div id="product-list"></div>
			</form>
		</div>
</template>

<script>
	return {
    data: function () {
      return {
        }
    },
    on: {
      pageInit: function(e, page) {
        const popUpCodes = document.getElementById('popup-codes')
        const popUpProducts = document.getElementById('popup-products')
        const popUpShops = document.getElementById('popup-shops');
        const productListDiv = document.getElementById('product-list');
        let productId = null;

        // Pop up barcode list
        $$(document).on('click', '.popup-code-list', function () {
          db.collection('products').get().then((snapshot) => {
            let result = '';
            snapshot.docs.forEach(doc => {
              const data = doc.data();
              result += `
                  <li>
                  <a href="#" class="item-content item-link popup-close">
                    <div class="item-inner">
                      <div data-product-code="${data.code}" class="get-product-code item-title">${data.code}</div>
                    </div>
                  </a>
                  </li>
							    `;
              });

            popUpCodes.innerHTML = result;
          });
        });

        // Pop up product list
        $$(document).on('click', '.popup-product-list', function () {
          db.collection('products').get().then((snapshot) => {
            let result = '';
            snapshot.docs.forEach(doc => {
              const data = doc.data();
              result += `
                  <li>
                  <a href="#" class="item-content item-link popup-close">
                    <div class="item-inner">
                      <div data-product-name="${data.name}" class="get-product-name item-title">${data.name}</div>
                    </div>
                  </a>
                  </li>
							    `;
              });

            popUpProducts.innerHTML = result;
          });
        });

        // Pop up shop list
        $$(document).on('click', '.popup-shop-list', function () {
          db.collection('shops').get().then((snapshot) => {
            let result = '';
            snapshot.docs.forEach(doc => {
              const data = doc.data();
              result += `
                  <li>
                  <a href="#" class="item-content item-link popup-close">
                    <div class="item-inner">
                      <div data-shop-id="${doc.id}" data-shop-name="${data.name}" class="get-shop-name item-title">${data.name}</div>
                    </div>
                  </a>
                  </li>
							    `;
              });

            popUpShops.innerHTML = result;
          });
        });

        // Get barcode data from pop up and add it to the form
        $$(document).on('click', '.get-product-code', function () {
          productCode = $$(this).data('product-code');
          document.getElementById('product-code').value = productCode;
        });

        // Get product name data from pop up and add it to the form
        $$(document).on('click', '.get-product-name', function () {
          productName = $$(this).data('product-name');
          document.getElementById('product-name').value = productName;
        });

        // Get shop name data from pop up and add it to the form
        let shopId;
        $$(document).on('click', '.get-shop-name', function () {
          shopName = $$(this).data('shop-name');
          shopId = $$(this).data('shop-id');
          document.getElementById('product-shop').value = shopName;
        });

        // Search by two filled field
        const twoFieldSearch = (stringName, fieldName, stringName2, fieldName2) => {
          db.collection('products').where(stringName, '==', fieldName).where(stringName2, '==', fieldName2).get().then((snapshot) => {
              let result = '';
              snapshot.docs.forEach(doc => {
                const data = doc.data();
                result += `
                 <div class="card-bg block block-strong inset">
                     <p>Product Code: <span>${data.code}</span></p>
                     <p>Product Name: <span>${data.name}</span></p>
                     <p>Price: <span>${data.price}</span></p>
                     <p>Quantity: <span id="search-quantity">${data.quantity}</span></p>
                     <div class="block display-flex justify-content-center">
                       <img style="width:200px;height:150px" id="test_img" src="assets/pictures/camera.png" />
                     </div>
                     <div class="display-flex justify-content-space-around">
                       <div class="stepper stepper-init stepper-small stepper-raised" data-value-el="#">
                         <div id="search-minus" class="stepper-button-minus update-search-quantity-minus" data-search-quantity="${data.quantity}" data-search-product-id="${doc.id}"></div>
                         <div id="search-plus" class="stepper-button-plus update-search-quantity-plus" data-search-quantity="${data.quantity}" data-search-product-id="${doc.id}"></div>
                       </div>
                     </div>
                   </div>
                 `;
              });
              productListDiv.innerHTML = result;
              });
        }

        // Search by one filled field
        const oneFieldSearch = (stringName, fieldName) => {
          db.collection('products').where(stringName, '==', fieldName).get().then((snapshot) => {
              let result = '';
              snapshot.docs.forEach(doc => {
                const data = doc.data();
                result += `
                 <div class="card-bg block block-strong inset">
                     <p>Product Code: <span>${data.code}</span></p>
                     <p>Product Name: <span>${data.name}</span></p>
                     <p>Price: <span>${data.price}</span></p>
                     <p>Quantity: <span id="search-quantity">${data.quantity}</span></p>
                     <div class="block display-flex justify-content-center">
                       <img style="width:200px;height:150px" id="test_img" src="assets/pictures/camera.png" />
                     </div>
                     <div class="display-flex justify-content-space-around">
                       <div class="stepper stepper-init stepper-small stepper-raised" data-value-el="#">
                         <div id="search-minus" class="stepper-button-minus update-search-quantity-minus" data-search-quantity="${data.quantity}" data-search-product-id="${doc.id}"></div>
                         <div id="search-plus" class="stepper-button-plus update-search-quantity-plus" data-search-quantity="${data.quantity}" data-search-product-id="${doc.id}"></div>
                       </div>
                     </div>
                   </div>
                 `;
              });
              productListDiv.innerHTML = result;
              });
        }

        // Real time update with Firebase
        const getRealTimeUpdatesFirebase = () => {
            const jsonObject = app.methods.dataToJson('#search-product-form');

            if(jsonObject.code != "" && jsonObject.name == "" && jsonObject.shop == "") {
              oneFieldSearch('code', jsonObject.code);
            } else if(jsonObject.code == "" && jsonObject.name != "" && jsonObject.shop == "") {
                oneFieldSearch('name', jsonObject.name);
            } else if(jsonObject.code == "" && jsonObject.name == "" && jsonObject.shop != "") {
                oneFieldSearch('shop', jsonObject.shop);
            } else if(jsonObject.code != "" && jsonObject.name != "" && jsonObject.shop == "") {
                twoFieldSearch('code', jsonObject.code, 'name', jsonObject.name);
            } else if(jsonObject.code != "" && jsonObject.name == "" && jsonObject.shop != "") {
                twoFieldSearch('code', jsonObject.code, 'shop', jsonObject.shop);
            } else if(jsonObject.code == "" && jsonObject.name != "" && jsonObject.shop != "") {
                twoFieldSearch('name', jsonObject.name, 'shop', jsonObject.shop);
            }
        }

        // // Get query
        $$(document).on('click', '.convert-product-form-to-data', function () { 
          if (app.methods.isSearchFormEmpty()) getRealTimeUpdatesFirebase();
          else app.dialog.alert('Please fill out the form first.', '');
        });

        // Subtract quantity
        $$(document).on('click', '.update-search-quantity-minus', function () {
          productId = $$(this).data('search-product-id');
          changeQuantity('update-search-quantity-minus', productId, $$(this).data('search-quantity'));
        });

        // Add quantity
        $$(document).on('click', '.update-search-quantity-plus', function () {
          productId = $$(this).data('search-product-id');
          changeQuantity('update-search-quantity-plus', productId, $$(this).data('search-quantity'));
        });

        // Function to add/subtract quantity
        const changeQuantity = (className, productId, productQuantity) => {
          let newProductQuantity = 0;
          const idValue = document.getElementsByClassName(className)[0].id;

          if(idValue == "search-plus") 
            newProductQuantity = parseInt(productQuantity) + 1;
          if(idValue == "search-minus") 
            if(parseInt(productQuantity) > 0) 
              newProductQuantity = parseInt(productQuantity) - 1;
          
          db.collection('products').doc(productId).update({
            quantity: newProductQuantity,
          });

          // Real time update on page
          getRealTimeUpdatesFirebase();
        }

        // If the user changes view empty the Search page
        $$(document).on('page:reinit', function (e) {
          app.methods.emptySearchForm();
        })

      } // pageInit
      
    }
  }

</script>