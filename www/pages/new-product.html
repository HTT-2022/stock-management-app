<template>
	<div class="page" data-name="new-product">
		<!-- Navbar-->
		<div class="navbar">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				<div class="left">
					<a href="#" class="link back">
						<i class="icon icon-back"></i>
						<span class="if-not-md">Back</span>
					</a>
				</div>
				<div class="title">Product</div>
			</div>
		</div>
		<!-- Page content-->
		<div class="page-content">
			<form class="list" id="new-product-form">
				<div class="list">
					<div class="list no-hairlines-md">
						<ul>
							<div class="row display-flex">
								<div class="col-95 align-content-space-around">
									<li class="item-content item-input">
										<div class="item-inner">
											<div class="item-input-wrap">
												<textarea class="resizable" placeholder="Code" id="product-code" name="code" required validate></textarea>
											</div>
										</div>
										<i class="icon f7-icons">barcode_viewfinder</i>
										<i class="icon material-icons if-md">barcode_viewfinder</i>
									</li>
								</div>
							</div>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-input-wrap">
										<textarea class="resizable" placeholder="Name" id="product-name" name="name" required validate></textarea>
									</div>
								</div>
							</li>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-input-wrap">
										<textarea class="resizable" placeholder="Price" id="product-price" name="price" required validate></textarea>
									</div>
								</div>
							</li>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-input-wrap">
										<textarea class="resizable" placeholder="Quantity" id="product-quantity" name="quantity" required validate></textarea>
									</div>
								</div>
							</li>
							<div class="row display-flex">
								<div class="col-100 align-content-space-around">
									<li class="item-content item-input">
										<div class="item-inner">
											<div class="item-input-wrap">
												<textarea class="resizable" placeholder="Shop" id="product-shop" name="shop" required validate></textarea>
											</div>
										</div>
										<a class="button popup-open popup-shop-list" href="#" data-popup=".popup-shop-list"><i class="icon f7-icons">cart</i></a>
										<a class="button popup-open popup-shop-list" href="#" data-popup=".popup-shop-list"><i class="icon material-icons if-md">cart</i></a>
									</li>
								</div>
							</div>
						</ul>
					</div>
				</div>
				<!-- Pop up list -->
				<div class="popup popup-shop-list">
					<div class="navbar">
						<div class="navbar-bg"></div>
						<div class="navbar-inner sliding">
							<div class="left">
								<a href="#" class="link popup-close">
									<i class="icon icon-back"></i>
									<span class="if-not-md">Back</span>
								</a>
							</div>
							<div class="title">Shop List</div>
						</div>
					</div>
					<div class="list">
						<ul id="popup-shops"></ul>
					</div>
				</div>
				<!-- Picture -->
				<div class="block display-flex justify-content-center">
					<div id="viewport" class="viewport">
						<img style="width:200px;height:150px" id="test_img" src="assets/pictures/camera.png" />
            <div id="uploading-picture" class="display-flex justify-content-center"></div>
					</div>
				</div>
				<!-- Button -->
				<div class="block">
					<div class="row display-flex justify-content-flex-end">
						<div class="col-30">
							<a href="#" id="photo-album" class="button button-raised button-fill photo-album">Album</a>
						</div>
						<div class="col-10"><span></span></div>
						<div class="col-30 ">
							<a href="#" id="take-picture" class="button button-raised button-fill take-picture">Camera</a>
						</div>
					</div>
				</div>
				<!-- Button -->
				<div class="row display-flex justify-content-center">
					<div class="col-80 align-self-center">
						<a href="#" class="button button-raised button-fill convert-product-form-to-data">Save</a>
					</div>
				</div>
			</form>
		</div>
	</div>
</template>

<script>
	return {
    data: function () {
      return {
        }
    },
    on: {
      pageInit: function(e, page) {
        const popUpUl = document.getElementById('popup-shops');
        const productShopInput = document.getElementById('product-shop');
        const cameraButton = document.getElementById('take-picture');
        const albumButton = document.getElementById('photo-album');
        const uploadingPictureDiv = document.getElementById('uploading-picture');

        // Pop up shop list
        $$(document).on('click', '.popup-shop-list', function () {
          db.collection('shops').get().then((snapshot) => {
            let result = '';
            snapshot.docs.forEach(doc => {
              const data = doc.data();
              result += `
                  <li>
                  <a href="#" class="item-content item-link popup-close">
                    <div class="item-inner">
                      <div data-shop-id="${doc.id}" data-shop-name="${data.name}" class="get-shop-name item-title">${data.name}</div>
                    </div>
                  </a>
                  </li>
							    `;
              });

            popUpUl.innerHTML = result;
          });
        });

        // Get shop data from pop up and add it to the form
        let shopId;
        $$(document).on('click', '.get-shop-name', function () {
          shopName = $$(this).data('shop-name');
          shopId = $$(this).data('shop-id');
          document.getElementById('product-shop').value = shopName;
        });

        // Set options for camera
        function setOptions(srcType) {
            var options = {
                quality: 100,
                destinationType: Camera.DestinationType.DATA_URL,
                sourceType: srcType,
                encodingType: Camera.EncodingType.JPEG,
                mediaType: Camera.MediaType.PICTURE,
                allowEdit: false,
                correctOrientation: true,
                // saveToPhotoAlbum: true, 
                // on some Android devices it gives "Error capturing image"
                cameraDirection: Camera.Direction.BACK,
            }
            return options;
        }

        // Take picture with camera
        function openCamera(selection) {
            var srcType = Camera.PictureSourceType.CAMERA;
            var options = setOptions(srcType);
            navigator.camera.getPicture(function cameraSuccess(image) {
                displayImage(image);
            }, function cameraError(error) {
                  alert(error);
            }, options);
        }

        // Open gallery and choose a picture
        function browsePicture(selection) {
            var srcType = Camera.PictureSourceType.PHOTOLIBRARY;
            var options = setOptions(srcType);
            navigator.camera.getPicture(function cameraSuccess(image) {
                displayImage(image);
            }, function cameraError(error) {
                  alert(error);
            }, options);
        }

        // Add picture to DOM
        function displayImage(data) {
            var viewport = document.getElementById('viewport');
            viewport.style.display = "block";
            viewport.style.position = "relative";
            document.getElementById("test_img").src = "data:image/jpeg;base64," + data;
        }

        // Uploading picture
        const uploadImageToFirebaseStorage = (filename, img) => {
          return new Promise((resolve, reject) => {
            // Create a root reference
            const storageRef = firebase.storage().ref();
            const ref = storageRef.child(filename);
            const uploadTask = ref.putString(img, 'base64');

            uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, 
              function(snapshot) {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log('Upload is ' + Math.trunc(progress) + '% done');
                uploadingPictureDiv.innerHTML = 'Upload is ' + Math.trunc(progress) + '% done';

                if(progress == 100) {
                  app.dialog.alert('Product added to the products list.', '');
                  app.methods.emptyNewProductForm();
                  document.getElementById("test_img").src = "assets/pictures/camera.png";
                  uploadingPictureDiv.innerHTML = "";
                }
                   
                switch (snapshot.state) {
                  case firebase.storage.TaskState.PAUSED: 
                    console.log('Upload is paused');
                    break;
                  case firebase.storage.TaskState.RUNNING: 
                    console.log('Upload is running');
                    break;
                }
              }, function(error) {
              switch (error.code) {
                case 'storage/unauthorized':
                  break;
                case 'storage/canceled':
                  break;
                case 'storage/unknown':
                  break;
              }
            }, function() {
              // Upload completed successfully, now we can get the download URL
              uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
                console.log('File available at', downloadURL);
                resolve(downloadURL);
              });
            });
          });
        };

        // Get new product data from form
        $$(document).on('click', '.convert-product-form-to-data', function () {
          if (app.methods.isProductFormEmpty()) {
            const jsonObject = app.methods.dataToJson('#new-product-form');

            // Create/Add products data to the shop
            db.collection('products').add({
              code: jsonObject.code,
              'name': jsonObject.name,
              'price': jsonObject.price,
              'quantity': jsonObject.quantity,
              'shop': jsonObject.shop,
            });

           // const img = document.getElementById("test_img").src.substring("data:image/jpeg;base64,".length);
            console.log(jsonObject.code + '.jpg');
          //  uploadImageToFirebaseStorage(jsonObject.code + '.jpg', img);
          } else app.dialog.alert('Please fill out the form first.', '');
        });

        cameraButton.addEventListener('click', openCamera);
        albumButton.addEventListener('click', browsePicture);
      } // pageInit
    }
  }

</script>