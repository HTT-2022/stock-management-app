<template>
	<div class="page" data-name="new-product">
    <!-- Navbar-->
		<div class="navbar">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				<div class="left">
					<a href="#" class="link back">
						<i class="icon icon-back"></i>
						<span class="if-not-md">Back</span>
					</a>
				</div>
				<div class="title">Product</div>
			</div>
		</div>
    <!-- Page content-->
		<div class="page-content">
			<form class="list" id="new-product-form">
				<div class="list">
					<div class="list no-hairlines-md">
						<ul>
							<div class="row display-flex">
								<div class="col-95 align-content-space-around">
									<li class="item-content item-input">
										<div class="item-inner">
											<div class="item-input-wrap">
												<textarea class="resizable" placeholder="Code" id="product-code" name="code" required validate></textarea>
											</div>
										</div>
										<i class="icon f7-icons">barcode_viewfinder</i>
										<i class="icon material-icons if-md">barcode_viewfinder</i>
									</li>
								</div>
							</div>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-input-wrap">
										<textarea class="resizable" placeholder="Name" id="product-name" name="name" required validate></textarea>
									</div>
								</div>
							</li>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-input-wrap">
										<textarea class="resizable" placeholder="Price" id="product-price" name="price" required validate></textarea>
									</div>
								</div>
							</li>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-input-wrap">
										<textarea class="resizable" placeholder="Quantity" id="product-quantity" name="quantity" required validate></textarea>
									</div>
								</div>
							</li>
							<div class="row display-flex">
								<div class="col-100 align-content-space-around">
									<li class="item-content item-input">
										<div class="item-inner">
											<div class="item-input-wrap">
												<textarea class="resizable" placeholder="Shop" id="product-shop" name="shop" required validate></textarea>
											</div>
										</div>
										<a class="button popup-open popup-shop-list" href="#" data-popup=".popup-shop-list"><i class="icon f7-icons">cart</i></a>
										<a class="button popup-open popup-shop-list" href="#" data-popup=".popup-shop-list"><i class="icon material-icons if-md">cart</i></a>
									</li>
								</div>
							</div>
						</ul>
					</div>
				</div>
        <!-- Pop up list -->
				<div class="popup popup-shop-list">
					<div class="navbar">
						<div class="navbar-bg"></div>
						<div class="navbar-inner sliding">
							<div class="left">
								<a href="#" class="link popup-close">
									<i class="icon icon-back"></i>
									<span class="if-not-md">Back</span>
								</a>
							</div>
							<div class="title">Shop List</div>
						</div>
					</div>
					<div class="list">
						<ul id="popup-shops"></ul>
					</div>
				</div>
        <!-- Picture -->
				<div class="block block-strong display-flex justify-content-center">
					<p class="align-self-center">PICTURE</p>
				</div>
				<div class="block">
					<div class="row display-flex justify-content-flex-end">
						<div class="col-30">
							<a href="#" id="photo-album" class="button button-raised button-fill photo-album">Album</a>
						</div>
						<div class="col-10"><span></span></div>
						<div class="col-30 ">
							<a href="#" id="take-picture" class="button button-raised button-fill take-picture">Camera</a>
						</div>
					</div>
				</div>
        <!-- Button -->
				<div class="row display-flex justify-content-center">
					<div class="col-80 align-self-center">
						<a href="#" class="button button-raised button-fill convert-product-form-to-data">Save</a>
					</div>
				</div>
			</form>
		</div>
	</div>
</template>

<script>
	return {
    data: function () {
      return {
        }
    },
    on: {
      pageInit: function(e, page) {
        const popUpUl = document.getElementById('popup-shops');
        const productShopInput = document.getElementById('product-shop');
        // const cameraButton = document.getElementById('take-picture');
        // const albumButton = document.getElementById('photo-album');

        // const fail = (msg) => {
        //   console.log(msg);
        //   alert(msg);
        // };

        // const pictureTaken = (data) => {
        //   console.log('picture taken');
        //   const imgSrc = "data:image/jpeg;base64," + data;
        //   var viewport = document.getElementById('viewport');
        //   viewport.style.display = "";
        //   document.getElementById("test_img").src = imgSrc;
        // }

        // const takePicture = () => {
        //   console.log('taking picture');
        //   navigator.camera.getPicture(pictureTaken, fail, {
        //     quality: 100,
        //     encodingType: Camera.EncodingType.JPEG,
        //     mediaType: Camera.MediaType.PICTURE,
        //     destinationType: Camera.DestinationType.DATA_URL, // FILE_URI, DATA_URL
        //     sourceType: Camera.PictureSourceType.CAMERA,
        //     saveToPhotoAlbum: true,
        //     cameraDirection: Camera.Direction.BACK, // only supported in iOS. Android always use back camera.
        //   });
        // }

        // const browsePicture = (type = Camera.EncodingType.JPEG) => {
        //   console.log('browsing picture');
        //   navigator.camera.getPicture(pictureTaken, fail, {
        //     sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
        //     encodingType: type, // PNG, JPEG
        //     quality: 100,
        //     mediaType: Camera.MediaType.PICTURE,
        //     destinationType: Camera.DestinationType.DATA_URL,
        //   });
        // };

        // Pop up shop list
        $$(document).on('click', '.popup-shop-list', function () {
          db.collection('shops').get().then((snapshot) => {
            let result = '';
            snapshot.docs.forEach(doc => {
              const data = doc.data();
              result += `
                  <li>
                  <a href="#" class="item-content item-link popup-close">
                    <div class="item-inner">
                      <div data-shop-id="${doc.id}" data-shop-name="${data.name}" class="get-shop-name item-title">${data.name}</div>
                    </div>
                  </a>
                  </li>
							    `;
              });

            popUpUl.innerHTML = result;
          });
        });

        // Get shop data from pop up and add it to the form
        let shopId;
        $$(document).on('click', '.get-shop-name', function () {
          shopName = $$(this).data('shop-name');
          shopId = $$(this).data('shop-id');
          document.getElementById('product-shop').value = shopName;
        });

        // Get new product data from form
        $$(document).on('click', '.convert-product-form-to-data', function () {
          if (app.methods.isProductFormEmpty()) {
            const jsonObject = app.methods.dataToJson('#new-product-form');

            // Create/Add products data to the shop
            db.collection('products').add({
              code: jsonObject.code,
              'name': jsonObject.name,
              'price': jsonObject.price,
              'quantity': jsonObject.quantity,
              'shop': jsonObject.shop,
            })

            app.methods.emptyNewProductForm();
            app.dialog.alert('Product added to the products list.', '');
          } else app.dialog.alert('Please fill out the form first.', '');
        });

        // cameraButton.addEventListener('click', takePicture);
        // albumButton.addEventListener('click', browsePicture);
      } // pageInit
    }
  }

</script>