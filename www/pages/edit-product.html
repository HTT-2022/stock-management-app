<template>
	<div class="page" data-name="edit-product">
		<!-- Navbar-->
		<div class="navbar">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				<div class="left">
					<a href="#" class="link back">
						<i class="icon icon-back"></i>
						<span class="if-not-md">Back</span>
					</a>
				</div>
				<div class="title">Edit Product Details</div>
			</div>
		</div>
		<!-- Page content-->
		<div class="page-content">
			<form class="list" id="edit-product-form">
				<div class="list">
					<div class="list no-hairlines-md">
						<ul class="row">
							<li class="col-95 item-content item-input">
								<div class="item-inner">
									<div class="item-input-wrap">
										<textarea class="resizable" placeholder="Code" id="product-code" name="code" required validate></textarea>
									</div>
								</div>
								<i class="icon f7-icons" id="product-barcode">barcode_viewfinder</i>
							</li>
							<li class="col-100 item-content item-input">
								<div class="item-inner">
									<div class="item-input-wrap">
										<textarea class="resizable" placeholder="Name" id="product-name" name="name" required validate></textarea>
									</div>
								</div>
							</li>
							<li class="col-100 item-content item-input">
								<div class="item-inner">
									<div class="item-input-wrap">
										<textarea class="resizable" placeholder="Price" id="product-price" name="price" required validate></textarea>
									</div>
								</div>
							</li>
							<li class="col-100 item-content item-input">
								<div class="item-inner">
									<div class="item-input-wrap">
										<textarea class="resizable" placeholder="Quantity" id="product-quantity" name="quantity" required validate></textarea>
									</div>
								</div>
							</li>
									<li class="col-95 item-content item-input">
										<div class="item-inner">
											<div class="item-input-wrap">
												<textarea class="resizable" placeholder="Shop" id="product-shop" name="shop" required validate></textarea>
											</div>
										</div>
										<i class="icon f7-icons popup-open popup-shop-list" data-popup=".popup-shop-list">cart</i>
									</li>
						</ul>
					</div>
				</div>
				<!-- Pop up list -->
				<div class="popup popup-shop-list">
					<div class="navbar">
						<div class="navbar-bg"></div>
						<div class="navbar-inner sliding">
							<div class="left">
								<a href="#" class="link popup-close">
									<i class="icon icon-back"></i>
									<span class="if-not-md">Back</span>
								</a>
							</div>
							<div class="title">Shop List</div>
						</div>
					</div>
					<div class="list">
						<ul id="popup-shops"></ul>
					</div>
				</div>
				<!-- Picture -->
				<div class="block display-flex justify-content-center">
					<div>
						<img style="width:200px;height:150px" id="imageFile" src="assets/pictures/camera.png">
					</div>
				</div>
				<!-- Button -->
				<div class="block">
					<div class="row display-flex justify-content-flex-end">
						<div class="col-30">
							<a href="#" id="photo-album" class="button button-raised button-fill photo-album">Album</a>
						</div>
						<div class="col-10"><span></span></div>
						<div class="col-30 ">
							<a href="#" id="take-picture" class="button button-raised button-fill take-picture">Camera</a>
						</div>
					</div>
				</div>
				<!-- Button -->
				<div class="row display-flex justify-content-center">
					<div class="col-80 align-self-center">
						<a href="#" class="button button-raised button-fill edited-product-data">Save</a>
					</div>
				</div>
			</form>
		</div>
	</div>
</template>

<script>
	return {
    data: function () {
      return {
        }
    },
    on: {
      pageInit: function(e, page) {
        const barcodeIcon = document.getElementById('product-barcode');
        const popUpUl = document.getElementById('popup-shops');
        const productShopInput = document.getElementById('product-shop');
        const cameraButton = document.getElementById('take-picture');
        const albumButton = document.getElementById('photo-album');

        // Barcode 
        function scanBarcode() {
          cordova.plugins.barcodeScanner.scan(
            function(result) {
              document.getElementById('product-code').value = result.text;
            },
            function(error) {
              alert("Scanning failed: " + error);
            }, {
              preferFrontCamera: false, // iOS and Android
              showFlipCameraButton: false, // iOS and Android
              showTorchButton: false, // iOS and Android
              torchOn: false, // Android, launch with the torch switched on (if available)
              disableAnimations: true, // iOS
              disableSuccessBeep: false // iOS and Android
            }
          );
        }

        // Pop up shop list
        $$(document).on('click', '.popup-shop-list', function() {
          db.collection('shops').get().then((snapshot) => {
            let result = '';
            snapshot.docs.forEach(doc => {
              const data = doc.data();
              result += `
                          <li>
                          <a href="#" class="item-content item-link popup-close">
                            <div class="item-inner">
                              <div data-shop-id="${doc.id}" data-shop-name="${data.name}" class="get-shop-name item-title">${data.name}</div>
                            </div>
                          </a>
                          </li>
                          `;
            });

            popUpUl.innerHTML = result;
          });
        });

        // Get shop data from pop up and add it to the form
        let shopId;
        $$(document).on('click', '.get-shop-name', function() {
          shopName = $$(this).data('shop-name');
          shopId = $$(this).data('shop-id');
          document.getElementById('product-shop').value = shopName;
        });

        // Set options for camera
        function setOptions(srcType) {
          var options = {
            quality: 50,
            destinationType: Camera.DestinationType.DATA_URL,
            sourceType: srcType,
            encodingType: Camera.EncodingType.JPEG,
            mediaType: Camera.MediaType.PICTURE,
            allowEdit: false,
            correctOrientation: true
          }
          return options;
        }

        // Take picture with camera
        function openCamera(selection) {
          var srcType = Camera.PictureSourceType.CAMERA;
          var options = setOptions(srcType);
          navigator.camera.getPicture(function cameraSuccess(imageUrl) {
            // Cordova Bug getPicture doesn't work properly
            displayImage(imageUrl);
          }, function cameraError(error) {
            console.debug("Unable to take picture: " + error, "app");
          }, options);
        }

        // Open gallery and choose a picture
        function openFilePicker(selection) {
          var srcType = Camera.PictureSourceType.SAVEDPHOTOALBUM;
          var options = setOptions(srcType);
          navigator.camera.getPicture(function cameraSuccess(imageUrl) {
            // Cordova Bug getPicture doesn't work properly
            displayImage(imageUrl);
          }, function cameraError(error) {
            console.debug("Unable to obtain picture: " + error, "app");
          }, options);
        }

        // Add picture to DOM
        function displayImage(img) {
          let image = document.getElementById('imageFile');
          image.src = "data:image/jpeg;base64," + img;
        }

        // Uploading picture
        function uploadImageToFirebaseStorage(filename, img) {
          const storageRef = firebase.storage().ref('products/' + filename);
          const uploadTask = storageRef.putString(img, 'base64');

          uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED,
            function(snapshot) {
              const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              console.log('Upload is ' + Math.trunc(progress) + '% done');
              uploadingPictureDiv.innerHTML = 'Upload is ' + Math.trunc(progress) + '% done';

              if (progress == 100) 
                app.dialog.alert('Product added to the products list.', '');

              switch (snapshot.state) {
                case firebase.storage.TaskState.PAUSED:
                  console.log('Upload is paused');
                  break;
                case firebase.storage.TaskState.RUNNING:
                  console.log('Upload is running');
                  break;
              }
            },

            function(error) {
              switch (error.code) {
                case 'storage/unauthorized':
                  break;
                case 'storage/canceled':
                  break;
                case 'storage/unknown':
                  break;
                case 'storage/invalid-format':
                  break;
              }
            },

            function() {
              uploadTask.snapshot.storageRef.getDownloadURL().then(function(url) {
                console.log('File available at', url);
              });
            });
        }

        // Check if the user added a picture or not
        function checkPicture(jsonObject) {
          try {
            console.log("hello");
            const img = document.getElementById("imageFile").src.substring("data:image/jpeg;base64,".length);
            uploadImageToFirebaseStorage(jsonObject.code + '.jpg', img);
            return true;
          } catch {
            app.dialog.alert('Please upload a picture!', '');
            return false;
          }
        }

        barcodeIcon.addEventListener('click', scanBarcode);
        cameraButton.addEventListener('click', openCamera);
        albumButton.addEventListener('click', openFilePicker);
      } // pageInit
    }
  }

</script>